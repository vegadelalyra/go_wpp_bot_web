<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin de Prompts</title>
    <!-- 1. Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. FontAwesome Icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <style>
        /* Custom styles for the app */
        body {
            font-family: 'Inter', sans-serif;
            /* Dark mode background */
            background-color: #111827; /* bg-gray-900 */
            color: #d1d5db; /* text-gray-300 */
            overflow-x: hidden; /* Prevent horizontal scroll */
        }
        /* Custom scrollbar for sidebar */
        .sidebar-nav::-webkit-scrollbar { width: 4px; }
        .sidebar-nav::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; } /* bg-gray-600 */
        .sidebar-nav::-webkit-scrollbar-track { background: transparent; }

        /* Animación de flotar para el ícono */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }
        .float-animation {
            animation: float 6s ease-in-out infinite;
        }

        /* Animation for the modal */
        .modal {
            transition: opacity 0.25s ease, transform 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        .modal.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
        }
        .modal:not(.hidden) {
            opacity: 1;
            transform: scale(1);
        }

        /* Estilo para el botón de login épico */
        .epic-login-button {
            background: linear-gradient(145deg, #4f46e5, #6366f1); /* Degradado púrpura-azul */
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .epic-login-button:hover:not(:disabled) {
            background: linear-gradient(145deg, #6366f1, #4f46e5); /* Invertir degradado */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            transform: translateY(-2px); /* Efecto de elevación */
        }
        .epic-login-button:disabled {
            background: #4b5563; /* bg-gray-600 */
            cursor: not-allowed;
            box-shadow: none;
        }
        /* Ensure textareas resize properly */
        textarea {
            resize: vertical; /* Allow vertical resize, disable horizontal */
            min-height: 20rem; /* h-80 */
        }
    </style>
</head>
<body class="text-gray-300">

    <!-- ====================================================== --><!-- LOGIN SCREEN (NO CHANGES) --><!-- ====================================================== --><div id="login-screen" class="flex items-center justify-center min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-black">
        <div class="w-full max-w-md text-center">
            <img src="Emy.png" alt="Emycommerce Logo" class="w-24 h-24 mx-auto mb-4 float-animation">
            <div class="p-8 space-y-6 bg-gray-800/50 backdrop-blur-lg rounded-xl shadow-2xl border border-gray-700">
                <h2 class="text-3xl font-bold text-center text-white">Admin de Prompts</h2>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-300 sr-only">Contraseña</label>
                        <input id="password" name="password" type="password" required class="w-full px-3 py-2 mt-1 bg-gray-700 border border-gray-600 text-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Contraseña">
                    </div>
                    <div>
                        <button type="submit" class="w-full flex justify-center py-2 px-4 rounded-md shadow-sm text-sm font-medium text-white epic-login-button focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <span id="login-btn-text">Ingresar</span>
                            <i id="login-spinner" class="fas fa-spinner fa-spin hidden"></i>
                        </button>
                    </div>
                    <p id="login-status" class="text-sm text-center text-red-400"></p>
                </form>
            </div>
        </div>
    </div>

    <!-- ====================================================== --><!-- DASHBOARD SCREEN (UPDATED) --><!-- ====================================================== --><div id="dashboard-screen" class="hidden">
        <div class="flex h-screen bg-gray-900">
            <!-- Sidebar (UPDATED NAV LOGIC) --><aside class="w-80 bg-gray-800 shadow-lg flex flex-col border-r border-gray-700">
                <div class="p-6 border-b border-gray-700">
                    <h2 class="text-2xl font-bold text-white">¡Hola, <span id="user-name"></span>!</h2>
                </div>
                <nav id="prompt-nav-list" class="flex-1 p-4 space-y-2 overflow-y-auto sidebar-nav">
                    <!-- Nav items will be injected by JS -->
                </nav>
                <div class="p-4 border-t border-gray-700">
                    <button id="logout-btn" class="w-full py-2 px-4 rounded-md text-sm font-medium text-gray-300 bg-gray-700 hover:bg-gray-600">
                        <i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesión
                    </button>
                </div>
                <div class="p-4 text-center text-xs text-gray-500 border-t border-gray-700">
                    Emycommerce
                </div>
            </aside>

            <!-- Main Content Area (UPDATED CONTENT LOGIC) --><main id="prompt-content-area" class="flex-1 p-6 md:p-10 overflow-y-auto">
                 <p class="text-center text-gray-400">Selecciona un prompt de la barra lateral para empezar.</p>
            </main>
        </div>
    </div>

    <!-- ====================================================== --><!-- CONFIRMATION MODAL (NO CHANGES) --><!-- ====================================================== --><div id="confirmation-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50">
        <div class="modal-content transform transition-all bg-gray-800 rounded-xl shadow-xl w-full max-w-2xl border border-gray-700">
            <div class="p-6">
                <h3 class="text-2xl font-bold text-white">Confirmar Cambios</h3>
                <p class="mt-2 text-gray-300">Estás a punto de modificar el prompt. Por favor, revisa los cambios y agrega una razón.</p>
                <div class="mt-4 max-h-60 overflow-y-auto p-4 bg-gray-900 rounded-lg border border-gray-700">
                    <h4 class="font-semibold text-white">Cambios a realizar:</h4>
                    <div class="mt-2">
                        <label class="text-xs font-medium text-red-400">--- ANTERIOR ---</label>
                        <pre id="modal-old-text" class="w-full p-2 text-sm bg-red-900/50 rounded text-red-300 whitespace-pre-wrap"></pre>
                    </div>
                    <div class="mt-2">
                        <label class="text-xs font-medium text-green-400">--- NUEVO ---</label>
                        <pre id="modal-new-text" class="w-full p-2 text-sm bg-green-900/50 rounded text-green-300 whitespace-pre-wrap"></pre>
                    </div>
                </div>
                <div class="mt-4">
                    <label for="modal-reason" class="block text-sm font-medium text-gray-300">Razón del cambio (Opcional)</label>
                    <textarea id="modal-reason" rows="3" class="w-full p-2 mt-1 bg-gray-700 border border-gray-600 text-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Ej: Ajuste de tono para ser más amigable..."></textarea>
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-800/50 rounded-b-xl flex justify-end space-x-3 border-t border-gray-700">
                <button id="modal-cancel-btn" class="py-2 px-4 text-sm font-medium text-gray-300 bg-gray-600 border border-gray-500 rounded-lg hover:bg-gray-500">
                    Cancelar
                </button>
                <button id="modal-confirm-btn" class="py-2 px-4 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">
                    Confirmar y Guardar
                </button>
            </div>
        </div>
    </div>


    <!-- ====================================================== --><!-- JAVASCRIPT APPLICATION (UPDATED) --><!-- ====================================================== --><script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- CONFIGURACIÓN ---
            const HARDCODED_SERVER_URL = "https://wpp-bot-admin.trycloudflare.com"; // <-- ¡RECUERDA CAMBIAR ESTO!

            // --- STATE ---
            const state = {
                token: null, // User JID
                userName: '',
                prompts: []
            };

            // --- DOM ELEMENTS ---
            const loginScreen = document.getElementById('login-screen');
            const dashboardScreen = document.getElementById('dashboard-screen');
            const loginForm = document.getElementById('login-form');
            const loginStatus = document.getElementById('login-status');
            const loginBtnText = document.getElementById('login-btn-text');
            const loginSpinner = document.getElementById('login-spinner');
            const passwordInput = document.getElementById('password');
            const userNameEl = document.getElementById('user-name');
            const promptNavList = document.getElementById('prompt-nav-list');
            const promptContentArea = document.getElementById('prompt-content-area');
            const logoutBtn = document.getElementById('logout-btn');
            const modal = document.getElementById('confirmation-modal');
            const modalOldText = document.getElementById('modal-old-text');
            const modalNewText = document.getElementById('modal-new-text');
            const modalReason = document.getElementById('modal-reason');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');

            // --- API FETCHER ---
            async function apiFetch(endpoint, method, body) {
                const url = HARDCODED_SERVER_URL + endpoint;
                const headers = { 'Content-Type': 'application/json' };
                if (state.token) {
                    headers['Authorization'] = `Bearer ${state.token}`;
                }
                try {
                    const options = { method, headers };
                    if (body) options.body = JSON.stringify(body);
                    const response = await fetch(url, options);
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || 'Server Error');
                    return data;
                } catch (err) {
                    console.error('API Fetch Error:', err);
                    const statusEl = document.getElementById('login-status') || document.getElementById('status'); // Use login status or dashboard status
                     if (statusEl) statusEl.textContent = err.message;
                    return null;
                }
            }

            // --- ON PAGE LOAD ---
            function init() {
                const savedToken = localStorage.getItem('token');
                if (savedToken) {
                    state.token = savedToken;
                    bootstrapDashboard();
                } else {
                    showScreen('login');
                }
                loginForm.addEventListener('submit', handleLogin);
                logoutBtn.addEventListener('click', handleLogout);
                modalCancelBtn.addEventListener('click', () => modal.classList.add('hidden'));
            }

            // --- AUTHENTICATION ---
            async function handleLogin(e) {
                e.preventDefault();
                setLoginLoading(true);
                const password = passwordInput.value;
                if (!password) {
                    loginStatus.textContent = 'Por favor, completa la contraseña.';
                    setLoginLoading(false);
                    return;
                }
                const data = await apiFetch('/api/login', 'POST', { password });
                if (data && data.token) {
                    state.token = data.token;
                    localStorage.setItem('token', state.token);
                    await bootstrapDashboard();
                } else {
                    // apiFetch already handles setting loginStatus on error
                    setLoginLoading(false);
                }
            }

            function handleLogout() {
                state.token = null; state.userName = ''; state.prompts = [];
                localStorage.removeItem('token');
                promptNavList.innerHTML = '';
                promptContentArea.innerHTML = '<p class="text-center text-gray-400">Selecciona un prompt para empezar.</p>';
                passwordInput.value = '';
                showScreen('login');
            }

            // --- DASHBOARD ---
            async function bootstrapDashboard() {
                const data = await apiFetch('/api/dashboard', 'GET');
                if (data && data.user) {
                    state.userName = data.user.username;
                    state.prompts = data.prompts || []; // Ensure prompts is an array
                    userNameEl.textContent = state.userName; // Display the JID
                    renderSidebarNav(state.prompts);
                    if (state.prompts.length > 0) {
                        renderPromptContent(state.prompts[0].id);
                        // Highlight first item after rendering
                        const firstLink = document.querySelector('.nav-link[data-prompt-id="' + state.prompts[0].id + '"]');
                        if (firstLink) {
                            firstLink.classList.add('bg-blue-900/50', 'text-blue-300');
                        }
                    } else {
                        promptContentArea.innerHTML = '<p class="text-center text-gray-400">No hay prompts configurados.</p>';
                    }
                    showScreen('dashboard');
                     // Reset login status in case there was a previous error message
                    if (loginStatus) loginStatus.textContent = '';
                } else {
                    // If dashboard fetch fails (e.g., invalid token), log out
                    handleLogout();
                }
                 setLoginLoading(false); // Ensure loading state is reset
            }

            // *** UPDATED ***
            function renderSidebarNav(prompts) {
                promptNavList.innerHTML = '';
                if (!prompts || prompts.length === 0) {
                     promptNavList.innerHTML = '<p class="p-3 text-sm text-gray-400">No hay prompts disponibles.</p>';
                     return;
                }

                prompts.forEach(prompt => {
                    const lastChanged = prompt.last_changed ? formatTimeAgo(new Date(prompt.last_changed)) : 'Nunca';
                    const navItem = document.createElement('a');
                    navItem.href = '#';
                    navItem.className = 'nav-link block p-3 rounded-lg hover:bg-gray-700 group';
                    navItem.dataset.promptId = prompt.id;

                    // Use prompt.name (Spanish) for the main link text
                    navItem.innerHTML = `
                        <div class="font-semibold text-gray-100 group-hover:text-blue-400">${escapeHTML(prompt.name)}</div>
                        <div class="text-xs text-gray-400">Actualizado ${lastChanged}</div>
                    `;
                    navItem.addEventListener('click', (e) => {
                        e.preventDefault();
                        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('bg-blue-900/50', 'text-blue-300'));
                        navItem.classList.add('bg-blue-900/50', 'text-blue-300');
                        renderPromptContent(prompt.id);
                    });
                    promptNavList.appendChild(navItem);
                });
            }

            // *** UPDATED ***
            function renderPromptContent(promptId) {
                const prompt = state.prompts.find(p => p.id === promptId);
                if (!prompt) {
                     promptContentArea.innerHTML = '<p class="text-center text-red-400">Error: No se encontró el prompt.</p>';
                     return;
                }

                const lastChanged = prompt.last_changed ? formatTimeAgo(new Date(prompt.last_changed)) : 'Nunca';

                const escapedContent = escapeHTML(prompt.content);
                const escapedName = escapeHTML(prompt.name);
                const escapedConcept = escapeHTML(prompt.concepto); // Use 'concepto' from API

                // Use prompt.name for title, prompt.concepto for subtitle
                promptContentArea.innerHTML = `
                <div class="max-w-4xl mx-auto">
                    <h1 class="text-4xl font-bold text-white">${escapedName}</h1>
                    <p class="mt-2 text-lg text-gray-300">${escapedConcept}</p>
                    <div class="mt-8 p-6 bg-gray-800 rounded-xl shadow-lg border border-gray-700">
                        <div class="grid grid-cols-1 md:grid-cols-11 gap-4 items-center">
                            <div class="md:col-span-5">
                                <label class="block text-sm font-medium text-gray-300">Prompt Original (Solo Lectura)</label>
                                <textarea id="original-prompt-area" readonly class="w-full p-3 mt-1 bg-gray-900 border border-gray-700 rounded-md text-gray-300">${escapedContent}</textarea>
                            </div>
                            <div class="text-center">
                                <i class="fas fa-arrow-right text-3xl text-gray-500 hidden md:block"></i>
                                <i class="fas fa-arrow-down text-3xl text-gray-500 block md:hidden"></i>
                            </div>
                            <div class="md:col-span-5">
                                <label class="block text-sm font-medium text-gray-300">Nuevo Prompt (Editable)</label>
                                <textarea id="editable-prompt-area" class="w-full p-3 mt-1 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">${escapedContent}</textarea>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mt-6">
                            <div class="text-sm text-gray-400">
                                <strong>Último cambio:</strong> <span id="prompt-last-change-info">${lastChanged}</span>
                            </div>
                            <button id="save-prompt-btn" data-prompt-id="${prompt.id}" class="py-2 px-5 font-semibold rounded-lg text-white bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                <span id="save-btn-text">MODIFICAR PROMPT</span>
                                <i id="save-spinner" class="fas fa-spinner fa-spin hidden"></i>
                            </button>
                        </div>
                         <p id="status" class="mt-4 text-sm text-center text-green-400"></p> <!-- Status for save operations -->
                    </div>
                </div>
                `;

                // Add event listener to the newly created button
                 const saveBtn = document.getElementById('save-prompt-btn');
                 if(saveBtn) {
                     saveBtn.addEventListener('click', handleSaveClick);
                 } else {
                    console.error("Save button not found after rendering prompt content.");
                 }
            }

            // --- PROMPT MODIFICATION ---
            function handleSaveClick(e) {
                const button = e.currentTarget;
                const promptId = button.dataset.promptId;
                 // Ensure promptId is valid before proceeding
                if (!promptId) {
                    console.error("Prompt ID is missing from save button.");
                    alert("Error: No se pudo identificar el prompt a guardar.");
                    return;
                }
                const originalTextArea = document.getElementById('original-prompt-area');
                const editableTextArea = document.getElementById('editable-prompt-area');

                 if (!originalTextArea || !editableTextArea) {
                    console.error("Text areas not found.");
                    alert("Error: No se pudieron encontrar las áreas de texto.");
                    return;
                 }


                const originalText = originalTextArea.value;
                const newText = editableTextArea.value;

                if (originalText === newText) {
                    alert("No hay cambios para guardar.");
                    return;
                }

                modalOldText.textContent = originalText;
                modalNewText.textContent = newText;
                modalReason.value = '';
                modal.classList.remove('hidden');

                // Assign the click handler directly, overwriting previous if any
                modalConfirmBtn.onclick = () => {
                     // Check if button is still valid before calling submit
                     const currentSaveBtn = document.getElementById('save-prompt-btn');
                     if(currentSaveBtn && currentSaveBtn.dataset.promptId === promptId) {
                         submitModification(currentSaveBtn, promptId, newText, modalReason.value);
                     } else {
                          console.error("Save button or prompt ID mismatch during confirmation.");
                          alert("Error de estado. Por favor, recarga la página.");
                          modal.classList.add('hidden');
                     }
                };
            }

           async function submitModification(button, promptId, newContent, reason) {
                setSaveButtonLoading(button, true);
                modal.classList.add('hidden');
                const statusEl = document.getElementById('status'); // Status inside the prompt content area
                if (statusEl) statusEl.textContent = `Guardando prompt ${promptId}...`;


                const data = await apiFetch(`/api/prompts/${promptId}`, 'PUT', {
                    content: newContent,
                    reason: reason || 'Sin motivo especificado'
                });

                if (data && data.success) {
                    // Update state locally first for immediate feedback (optional but good UX)
                    const promptIndex = state.prompts.findIndex(p => p.id === parseInt(promptId));
                    if (promptIndex > -1) {
                        state.prompts[promptIndex].content = newContent;
                         // Ideally, the API would return the updated timestamp
                         // For now, we'll refetch everything to get the timestamp
                    }

                    // Refetch all data to update sidebar and timestamps
                    await bootstrapDashboard();
                     // Re-render the current prompt specifically to keep focus
                     renderPromptContent(parseInt(promptId));
                     // Re-highlight the current nav item
                     const currentLink = document.querySelector(`.nav-link[data-prompt-id="${promptId}"]`);
                     if (currentLink) currentLink.classList.add('bg-blue-900/50', 'text-blue-300');

                    if (statusEl) statusEl.textContent = "✅ ¡Prompt actualizado con éxito!";
                    // Clear message after a delay
                    setTimeout(() => { if (statusEl) statusEl.textContent = ''; }, 3000);


                } else {
                     if (statusEl) statusEl.textContent = "❌ Error al guardar el prompt.";
                     // Re-enable button on failure
                     setSaveButtonLoading(button, false);
                }
                 // Make sure loading state is always reset eventually, even on error
                 // However, bootstrapDashboard() calls setLoginLoading(false) which might interfere
                 // We call it explicitly here for the save button.
                 setSaveButtonLoading(button, false);
            }


            // --- UI HELPERS ---
            function showScreen(screenName) {
                loginScreen.classList.add('hidden');
                dashboardScreen.classList.add('hidden');
                if (screenName === 'login') loginScreen.classList.remove('hidden');
                else dashboardScreen.classList.remove('hidden');
            }

            function setLoginLoading(isLoading) {
                 const button = loginForm.querySelector('button');
                if (isLoading) {
                    loginStatus.textContent = '';
                    loginBtnText.classList.add('hidden');
                    loginSpinner.classList.remove('hidden');
                    if (button) button.disabled = true;
                } else {
                    loginBtnText.classList.remove('hidden');
                    loginSpinner.classList.add('hidden');
                     if (button) button.disabled = false;
                }
            }

            function setSaveButtonLoading(button, isLoading) {
                if (!button) return; // Guard clause
                const text = button.querySelector('#save-btn-text');
                const spinner = button.querySelector('#save-spinner');
                if (isLoading) {
                    if (text) text.classList.add('hidden');
                    if (spinner) spinner.classList.remove('hidden');
                    button.disabled = true;
                } else {
                    if (text) text.classList.remove('hidden');
                    if (spinner) spinner.classList.add('hidden');
                    button.disabled = false;
                }
            }

            function formatTimeAgo(date) {
                if (!(date instanceof Date) || isNaN(date)) return 'fecha inválida';
                const seconds = Math.floor((new Date() - date) / 1000);
                if (seconds < 5) return 'ahora mismo';
                let interval = seconds / 31536000;
                if (interval > 1) return `hace ${Math.floor(interval)} años`;
                interval = seconds / 2592000;
                if (interval > 1) return `hace ${Math.floor(interval)} meses`;
                interval = seconds / 86400;
                if (interval > 1) return `hace ${Math.floor(interval)} días`;
                interval = seconds / 3600;
                if (interval > 1) return `hace ${Math.floor(interval)} horas`;
                interval = seconds / 60;
                if (interval > 1) return `hace ${Math.floor(interval)} min`;
                return `hace ${Math.floor(seconds)} seg`;
            }
             function escapeHTML(str) {
                 if (typeof str !== 'string') return '';
                 return str.replace(/[&<>"']/g, match => ({
                     '&': '&amp;',
                     '<': '&lt;',
                     '>': '&gt;',
                     '"': '&quot;',
                     "'": '&#39;'
                 }[match]));
             }


            // --- START THE APP ---
            init();
        });
    </script>
</body>
</html>

